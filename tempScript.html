
    <script src="./js/googleJsapi.js" type="text/javascript"></script>
    <script src="./js/raphael.js" type="text/javascript"></script>
    <script src="./js/pie.js" type="text/javascript"></script>
    <script src="./js/rawinflate.js"></script>
    <script src="./js/rawdeflate.js"></script>
    <script src="./js/html2canvas.js"></script>
    <script src="./Scripts/WHAF_auxFeatures.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_analysis.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_bookMark_snaps.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_chartQueries.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_core.js" type="text/javascript"></script> 
    <script src="./Scripts/WHAF_DSS_startups.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_guides.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_indexLayers.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_map.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_misc.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_scaleLayers.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_utilities.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_config.js" type="text/javascript"></script>
    <script src="./Scripts/WHAF_workflow.js" type="text/javascript"></script>
    <script src="./js/jquery-1.10.2.min.js" type="text/javascript"></script>
    <script src="./js/ui.1.10.3.jquery-ui.js" type="text/javascript"></script>
    <script src="./js/bootstrap.js"></script>
    <script src="./js/bootstrap-colorpicker.js"></script>
    <script src="./js/justgage.js"></script>
    <script src="./js/jquery.extras.js"></script>   
    <script src="./js/js.arcgis.com.3.13.js" type="text/javascript"></script>
    <script>

        // Google analytics code to allow for app traffic tracking
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-73695462-2', 'auto');
        ga('send', 'pageview');
    

        //DEFINING GLOBAL VARIABLES
        // primary global object, mapFeatures - list of aux features we want to display in the primary view of added features.
        var WHAFapp={currentMapParams:{allowedOffset: 10,hillShadeOp:1, Bsmp:'sat',indOp:0.8,theseFeatures:[],mapFeatures:["1.11", "1.13", "1.12", "1.14", "1.15","2.11", "2.12", "2.13"]}, template:{layoutOptions:{},format:'pdf'},snpNumber:1 ,displayedSnap:-1,snapZoom:0.16, sideBySideZoom:0.3, bitly:{'Key':'R_85d9a34c0cd44ff4b05b3b066a8300fd','genAccessKey':'3694b5c419f31188e48e14f3abe720ce8e6aba2b'},demikulu:'',suspender:false,flyOverUrl:"http://files.dnr.state.mn.us/natural_resources/water/watersheds/tool/watersheds/watershed_flyover/",landuseData:{},loadingLyrs:[],nonSelectableLayer:{}, selectableLayer:{loadStatus:"ready",impairmentSelections:{serial:400},fields:{},availId:40},impairments:{url:'http://pca-gis02.pca.state.mn.us/arcgis/rest/services/EDA/swedaV2/MapServer/',group:8,impField:'IMP_PARAM',streams:{layerIds:[9,10],impParams:[],impParamsAsUniqueVal:[]},wetlands:{layerIds:[11,12],impParams:[],impParamsAsUniqueVal:[]},lakes:{layerIds:[13,14],impParams:[],impParamsAsUniqueVal:[]}},genCounter:0,manActionId:33300};

        var w = window,d = document,e = d.documentElement,g = d.getElementsByTagName('body')[0],x = w.innerWidth || e.clientWidth || g.clientWidth,y = w.innerHeight || e.clientHeight || g.clientHeight, map, mainMap, majors, index, selectedWatershed = {}, starLocation={}, extent, stateExtent, initExtent, content, err, navToolbar, layers, legendd, geocoder, upstGrahics,graphicWSRecord = [],graphicHiLiteWSRecord = [], featureLayersDisplayed = [],layerInfos = [], mapParamObject = {params: false}, analyzer, counterR = 0,unAvailGDRS = 0, layerBoxState={layerBoxPopulated:false};


        //global definitions of web services urls
        var watershedsURL="http://arcgis.dnr.state.mn.us/arcgis/rest/services/ewr/whaf_watersheds/MapServer", assessmentURL = "http://arcgis.dnr.state.mn.us/arcgis/rest/services/ewr/whaf_indexscores/MapServer", waterBudgetURL = "http://arcgis.dnr.state.mn.us/arcgis/rest/services/ewr/whaf_watersheddata/MapServer/5", auxURL = "http://arcgis.dnr.state.mn.us/arcgis/rest/services/ewr/whaf_auxiliaryfeatures_sde/MapServer", masksURL="http://arcgis.dnr.state.mn.us/arcgis/rest/services/ewr/whaf_watersheds/MapServer/";
        var GDRS1 = 'http://arcgis.intranet.mndnr.dnr.state.mn.us/arcgis/rest/services/quicklayers/mndnr_hydrography/MapServer',
            GDRS2 = 'http://arcgis.intranet.mndnr.dnr.state.mn.us/arcgis/rest/services/quicklayers/mndnr_adminfeatures/MapServer',
            GDRS3 = 'http://arcgis.intranet.mndnr.dnr.state.mn.us/arcgis/rest/services/quicklayers/mndnr_environment/MapServer',            
            hillshadeService='http://arcgis.dnr.state.mn.us/arcgis/rest/services/elevation/mn_hillshade_cache/MapServer', 
            hillshadeLayer = 3,hillShadeLayerServed,GDRS_Groups = [GDRS1, GDRS2, GDRS3],layerItemID = 77700, BS, mode, current = 0,oldAuxLayers = [], teaser, auxFeatObject = {}, auxOptions = [],auxFeatObjectNew = {}, auxFeatObjectNew2 = {}, auxFeatObjectUrl = {}, analyzeCtmnts = [],AnalyzeRange = 5,CtmentInMajorQT, analyzeIndexList = [],analyticIndex = {}, messageListAnalyze = [],tempiListi = [],indexNameList = [],identifyTask = false,identifyParams=false, fader = true,indexDesxObj,
                mapParamsList = ["indexLayer", "opcty", "auxFtLst", "aux", "xtnt", "Bsmp", "Upstrm", "Dnstrm", "ctmt", "upSymbol", "dnSymbol", "Mj", "HO", "HS","Plc", "Msk", "tU","tD", "tMj", "tBsn", "tC"], 

                MaskWS_checker, MaskDnstr_checker, MaskUpstr_checker, MaskCtmnt_checker, graphicsBin=[], runningMapNumber=1, charts={status:false};

            //global object to handle decision support module parameters
            var DSS_objectives = { 
                    point:{}, 
                    name:"",
                    catchmenter:function(){executeCatchQueryC_asFL()},
                    availableObjectives:{},
                    decisionObjectives:{
                        scale:{kept:[],dismissed:[]},
                        context:{kept:[],dismissed:[]},
                        indexScore:{kept:[],dismissed:[],overviewed:[]},
                        localKnowledge:[],
                        misc:[],
                        dismissed:[],
                        scalesViewed:false,
                        overview:false
                    },
                    thresholds:{
                        low:50,
                        high:75
                    },
                    decisionObjectivesSerial:88800,
                    currentDssSection:'mStep1',
                    gauges:{},
                    disaplayedIndex:-1,
                    displayedContextMap:-1,
                    displayedScaleStep:0,
                    evalStep:0,
                    mapNameSerial:1
                };

            var opcity = String(WHAFapp.currentMapParams.hillShadeOp*100);

            //SYMBOLS
            var markerSymbol, noSymb,maskSymbol,mwsSymbol_sat, mwsSymbol_nonSat, bsnSymbol,dnstrSymbol,upstrSymbol,symbol;

        //FUNCTIONS ARRANGING PAGE LAYOUT, JQUERY UI AND CONTROLS 
        $(function () {

            console.log("Allowable Offset: ", WHAFapp.currentMapParams.allowedOffset)

            $('#snapShotsArea').sortable({
                start:function(){
                    $(this).addClass('noclick');
                }
            });
            $('.titlStay').click(function(e) {
                e.stopPropagation();
            });

            popoverInit();//sets up popover descriptions for health indices

            $('#featureTabs').tabs()
            fixTabsCss();
            var $select = $(".1-100");
            for (i = 1; i <= 50; i++) {
                $select.append($('<option></option>').val(i).html(i))
            };
            $('input, textarea').placeholder();  
            $('#AddingRestPoint').change(function () {processRestUrl2()});
            $('#adHocLayerList').keyup(function (){layerFilter()});
            $(".indexRadio").buttonset();
            $('*').tooltip();
            $("#bookmarkModal .btn").tooltip('disable');
            $('.scoreButton').children().popover({trigger: 'hover', placemnt:'right', html:true});
            $('.scoreBtn').popover({trigger: 'hover', placemnt:'right', html:true});
            $("#sortable").sortable({ cancel: "#hillshadeButton" });            
            $("#sortable").disableSelection();
            $("#sortable").sortable({
                start: function (event, ui) {
                    var start_pos = ui.item.index();
                    var lyr = ui.item[0].id;
                    ui.item.data('start_pos', start_pos);
                },
                update: function (event, ui) {
                    var lyr = ui.item[0];
                    var zz = $(lyr).find("input").attr("onclick").split(" ");
                    var n = zz[2].length - 3;
                    var r = zz[2].substr(1, n);
                    var z = zz[3].length - 1;
                    var q = String(zz[3].substr(0, z));
                    var i = "/";
                    var u = r+i+q;0
                    var start_pos = ui.item.data('start_pos');
                    var end_pos = $(ui.item).index();
                    reorderByList();
                    reorderTheseFeatures();
                }
            });

            $("#selSortable1").sortable({
                update: function(event, ui){
                    reorderImpairesLayers();                
                }
            })

            $("#pieChartModal, #waterUsePlace, #legendPlace, #featuresPlace").draggable({cancel: "#featurePlace, #legendAux",scroll: false});
            $("#myModal, #bookmarkModal").draggable({cancel:"#bookmarkInnerBox", scroll: false});
            $("#layersModal").draggable({cancel: "#adHocLayerListUl, #adHocLayerList, #adHocLayerLister2",scroll: false});
            $("#appInfoModal").draggable({scroll: true}).resizable();
            $('#layerSelectionModal').draggable({cancel: "#impLayerNameBox, #selTabs"});
            $( "#mapRunSortable" ).sortable().disableSelection();
            $("#myCarousel2").carousel('pause'); $("#myCarouseTut").carousel('pause');
            $( "#hillSlider" ).slider({value: opcity,
                slide: function (event, ui) {
                    changeHillOpacity(ui.value);
                    $("#hillSlider").slider("value", ui.value);
                }
            });
            $( "#aSlider" ).slider({
                value: WHAFapp.currentMapParams.indOp*100,
                slide: function (event, ui) {
                    changeScoreOpacity(ui.value);
                    $("#aSlider").slider("value", ui.value);
                }
            });
            $('.nav-tabs').button();
            $(window).resize(function () {
                resizeElementHeight('map');
                try{resizeElementHeight('dropDownWS', 180)}catch(err){};
            });
            $('#snapMax').mouseenter(function(){
                var k=$('#snapShotsArea').find('.mapSnap').length
                if(k==1){
                    setTimeout(function () {
                        $('#snapShotsArea, #snapMin').fadeIn(800);
                        $('#snapMax').hide();                        
                    }, 300)      
                }
                else if(k>1){
                    setTimeout(function () {
                        $('#snapShotsArea, #snapMin, .snapCtrl').fadeIn(800)
                        $('#snapMax').hide();
                    }, 300)      
                }
            })
        });
        

        //RETRIEVING GOOGLE CHARTS MODULE
        google.load("visualization", "1", {
            packages: ["corechart"]
        });  
       
        //RTRIEVING ESRI API MODULES
        require([
            "dojo/ready",
            "esri/map",
            "esri/dijit/Basemap",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/graphic",
            "esri/layers/FeatureLayer","esri/layers/DynamicMapServiceLayer",
            "esri/layers/ImageParameters",
            "esri/renderers/Renderer",
            "esri/tasks/query",
            "esri/tasks/QueryTask",
            "esri/toolbars/navigation",
            "esri/toolbars/draw",
            "esri/tasks/GeometryService",
            "esri/geometry/Extent",
            "esri/geometry/Point",
            "esri/dijit/Legend",
            "esri/dijit/Print",
            "esri/tasks/PrintTask",
            "esri/tasks/PrintParameters",
            "esri/tasks/PrintTemplate", 
            "esri/request", 
            "esri/config",
            "dojo/_base/array",
            "esri/dijit/Geocoder",
            "dojo/dom",
            "dojo/parser",
            "esri/SpatialReference",
            "esri/renderers/SimpleRenderer",
            "dojo/domReady!"

        ],function(ready,Map,Basemap,SimpleMarkerSymbol,Graphic,FeatureLayer,DynamicMapServiceLayer,ImageParameters,Renderer,Query,QueryTask,Navigation,Draw,GeometryService,Extent,Point,Legend,Print,PrintTask,PrintParameters,PrintTemplate,esriRequest,esriConfig,arrayUtils,Geocoder,dom,parser,SpatialReference,SimpleRenderer) { 

            

            function constructorGetter (cons){
                return cons;
            }

            WHAFapp.ExtentCons = constructorGetter(Extent);
            WHAFapp.DrawCons = constructorGetter(Draw);
            WHAFapp.SimpleMarkerSymbolCons = constructorGetter(SimpleMarkerSymbol);
            WHAFapp.GraphicCons = constructorGetter(Graphic);
            WHAFapp.FeatureLayerCons = constructorGetter(FeatureLayer);
            WHAFapp.SimpleRendererCons = constructorGetter(SimpleRenderer);
            WHAFapp.ImageParametersCons = constructorGetter(ImageParameters);
            WHAFapp.DynamicMapServiceLayerCons = constructorGetter(DynamicMapServiceLayer);
            WHAFapp.QueryCons = constructorGetter(Query);
            WHAFapp.QueryTaskCons = constructorGetter(QueryTask);
            WHAFapp.esriRequestCons = constructorGetter(esriRequest);
            WHAFapp.arrayUtilsCons = constructorGetter(arrayUtils);
            WHAFapp.PrintTemplateCons = constructorGetter(PrintTemplate);
            WHAFapp.PrintParamsCons = constructorGetter(PrintParameters);
            WHAFapp.PrintTaskCons = constructorGetter(PrintTask);
            WHAFapp.domCons = constructorGetter(dom);
            WHAFapp.mapCons = constructorGetter(Map)


            //PRINTING VARS AND CONFIGURATION
            // WHAFapp.printUrl = "http://arcgis.dnr.state.mn.us/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task";
    
            esri.config.defaults.io.corsEnabledServers.push('arcgis.dnr.state.mn.us');
            
            parser.parse();
            
            esri.config.defaults.io.alwaysUseProxy=false;
            esri.config.defaults.io.corsDetection = false;

            //DEFINE SYMBOLS

            markerSymbol = new WHAFapp.SimpleMarkerSymbolCons();
            markerSymbol.setPath("M22.5,14H14v8.5c0,0.276-0.224,0.5-0.5,0.5h-4C9.224,23,9,22.776,9,22.5V14H0.5  C0.224,14,0,13.776,0,13.5v-4C0,9.224,0.224,9,0.5,9H9V0.5C9,0.224,9.224,0,9.5,0h4C13.776,0,14,0.224,14,0.5V9h8.5  C22.776,9,23,9.224,23,9.5v4C23,13.776,22.776,14,22.5,14z");
            markerSymbol.setColor('white');




            noSymb = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_NULL));
            maskSymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 255, 255, 0]), 0), new dojo.Color([0, 0, 0, .7]));
            mwsSymbol_sat= new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([255, 255, 255]), 2), new dojo.Color([125, 125, 125, 0]));
            mwsSymbol_nonSat= new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 0, 0]), 2), new dojo.Color([125, 125, 125, 0]));

            bsnOutlineSymbol=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([115, 0, 76, 1]), 1.9), new dojo.Color([0, 0, 0, .7]));

            dnstrOutlineSymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 0, 255, 1]), 1), new dojo.Color([0, 0, 255, .7]));

            downFill = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_NULL, new dojo.Color([0, 0, 255]), 1), new dojo.Color([0, 0, 255, .6]));

            upFill = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_NULL, new dojo.Color([0, 0, 255]), 1), new dojo.Color([0, 200, 255, .6]));

            upstrOutlineSymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([191, 44, 162]), 2), new dojo.Color([125, 125, 125, 0]));

            symbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 0, 255]), 1), new dojo.Color([0, 0, 255, .6]));

            blueFill = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_NULL, new dojo.Color([0, 0, 0, 0]), 0), new dojo.Color([0, 0, 255, .6]));

            catOutline = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_NULL, new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 255, 191]), 2), new dojo.Color([125, 125, 125, 0]));

            $('#tutPlace').load('tutorial.html', function(){tutorialLoad()});
            $('#BMWarningPlace').load('BookmarkWarning.html');
            $('#magicWarningPlace').load('magicWarning.html');
            $('#helpPopPlace').load('helpPop.html');
            $('#helpAlertPlace').load('helpAlert.html');            
            $('#disclaimerPlace').load('disclaimer.html');
            $('#waterUsePlace').load('waterUseCharts.html');
            $('#info1').load('whatsAwatershed.html');            
            $('#mapScalePlace').load('scaleButtons.html', function(){resizeElementHeight('dropDownWS', 180);
                $('#majorsDDButton').click(function(){topWSDD()});
            });
            // $('#appInfoPlace').load('appInfoModal.html');
            $('#layerSelectionModal').load('layerSelect.html');
            $('#magicBox').load('magic.html',magicSetter());

           
            try{serverTest(masksUrl);}catch(err){console.log("unable to test server")}
            
            getGDRS_Feature(GDRS_Groups);

            try{var classList = $("html").attr('class').split(/\s+/);
                $.each(classList, function (index, item) {
                    if (item == 'dj_ie7' || item == 'dj_ie8') {
                        alert("This application works best on newer versions of Internet Explorer (9 or up), or with other browsers such as Firefox, Chrome or Safari. Please consider swithching to one of those.");
                        $("#dropDownWS").css("width", 250);
                        $("#dropDownHowToList").css("height", 300).css("width", 300);
                    }
                });
            }catch(v){};

            resizeElementHeight('map');
            stateExtent = stateExtentBuffer(0.2);
            
            if(getURLParameter('p') && getURLParameter('p')!== null){
            } else{//IF PARAMETERS ARE PASSED OLD STYLE, CREATE MAP PARAMS OBJECT
                console.log("getting params the old way");
                for (i = 0; i < mapParamsList.length; i++) {
                    if (getURLParameter(mapParamsList[i]) != "null") {
                        mapParamObject[mapParamsList[i]] = getURLParameter(mapParamsList[i]);
                        mapParamObject.params = true;
                    }
                }
            }

            // evalScales(mapParamObject);
            evalExtentParams(mapParamObject);
            evalBaseMapParam(mapParamObject);
            
            map= new Map("map", {
                basemap: evalBaseMapParam(WHAFapp.currentMapParams.Bsmp),
                extent: initExtent
            });

            offsetCheck();//adjusts allowable offset for feature service layers to maximize performance
            console.log("Allowable Offset: ", WHAFapp.currentMapParams.allowedOffset);
                 
            mainMap = map;
            
            // mode = "watershedZoom";

            map.on("load", function (){
                alert("loaded")
                loadQT();                
                $('body').animate({'opacity':1}, 1000);
                initImpairedModule();
                completeParamLoad();//COMPLETES LOADING OF MAP PARAMATERS AS PASSED BY URL
            });

            setIndexLayer();

            // setPrintInfo();
            var spatialReferenceG = new SpatialReference({
                wkid: 102100
            });

            auxInit1(); //sets auxiliary layers
           
            $('#featuresPlace').hide();

            function loadQT() {//initiates the map (watershed outlines and more)
                try {
                    WS_functionality();
                    loadBasins();

                } catch (err) {
                    setTimeout(function () {
                        console.log("trying again"), WS_functionality()
                    }, 100);
                };
            };
            map.on("Click", executeClick);
            map.on("Click", executeIdentifyTask);
            map.on("update-start", function(){
                showLoad();WHAFapp.mapLoading=1;
            });           
            map.on("update-end", doodleJump);

            function doodleJump(evt){
                $("#loader").hide();updateTrigger();legendd.refresh()
            }


            map.on("extent-change", function(){offsetCheck()});

            legendd = new Legend({
                map: mainMap,
                layerInfos: layerInfos
            }, "legendAux");
            legendd.startup();

            navToolbar = new Navigation(map);


            geocoder = new Geocoder({
                map: map
            }, "search");
            geocoder.startup();
            $('.esriGeocoderSearch').on( "click", function() {searchShow()})
            $('.esriGeocoderReset ').on( "click", function() {searchHide()})

            popBmarkPane();

    });


    </script>